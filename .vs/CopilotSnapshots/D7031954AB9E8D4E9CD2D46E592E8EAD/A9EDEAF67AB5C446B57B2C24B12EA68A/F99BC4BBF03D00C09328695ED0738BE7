using Microsoft.AspNetCore.Mvc.Rendering;
using SupermercadoCRUD2.Data.Repositorios;
using SupermercadoCRUD2.Models.Dto;
using SupermercadoCRUD2.Models.Entity;

namespace SupermercadoCRUD2.Servicios
{
    public class ServicioProductos
    {
        private readonly IProductoRepositorio _repositorio;

        public ServicioProductos(IProductoRepositorio repositorio)
        {
            _repositorio = repositorio;
        }

        // ---- LISTAR ----
        public List<ProductoDto> Listar()
        {
            var productos = _repositorio.Listar();

            return productos.Select(p => new ProductoDto
            {
                IdProducto = p.IdProducto,
                Nombre = p.Nombre,
                Medida = p.Medida,
                Precio = p.Precio,
                Stock = p.Stock,
                IdCategoria = p.IdCategoria,
                NombreCategoria = p.Categoria != null ? p.Categoria.Nombre : ""
            }).ToList();
        }

        // ---- OBTENER POR ID ----
        public ProductoDto? ObtenerPorId(int id)
        {
            var producto = _repositorio.ObtenerPorId(id);
            if (producto == null) return null;

            return new ProductoDto
            {
                IdProducto = producto.IdProducto,
                Nombre = producto.Nombre,
                Medida = producto.Medida,
                Precio = producto.Precio,
                Stock = producto.Stock,
                IdCategoria = producto.IdCategoria,
                NombreCategoria = producto.Categoria != null ? producto.Categoria.Nombre : ""
            };
        }

        // ---- CREAR ----
        public void Crear(ProductoDto dto)
        {
            // Obtener el último ID existente
            int ultimoId = _repositorio.ObtenerUltimoId();

            var nuevo = new Producto
            {
                IdProducto = ultimoId + 1,
                Nombre = dto.Nombre,
                Medida = dto.Medida,
                Precio = dto.Precio,
                Stock = dto.Stock,
                IdCategoria = dto.IdCategoria
            };

            _repositorio.Crear(nuevo);
        }

        // ---- EDITAR ----
        public void Editar(ProductoDto dto)
        {
            var producto = new Producto
            {
                IdProducto = dto.IdProducto,
                Nombre = dto.Nombre,
                Medida = dto.Medida,
                Precio = dto.Precio,
                Stock = dto.Stock,
                IdCategoria = dto.IdCategoria
            };

            _repositorio.Editar(producto);
        }

        // ---- ELIMINAR ----
        public void Eliminar(int id)
        {
            _repositorio.Eliminar(id);
        }

        // ---- OBTENER CATEGORÍAS ----
        public List<SelectListItem> ObtenerCategorias()
        {
            var categorias = _repositorio.ListarCategorias();

            return categorias.Select(c => new SelectListItem
            {
                Value = c.IdCategoria.ToString(),
                Text = c.Nombre
            }).ToList();
        }

        // ---- OBTENER SIGUIENTE ID ----
        public int ObtenerSiguienteId()
        {
            int ultimoId = _repositorio.ObtenerUltimoId();
            return ultimoId + 1;
        }
    }
}
